include $(TRUSTZONE_CUSTOM_BUILD_PATH)/common_config.mk

ifeq ($(TARGET_BUILD_VARIANT),eng)
  MICROTRUST_INSTALL_MODE ?= Debug
else
  MICROTRUST_INSTALL_MODE ?= Release
endif
ifeq ($(MICROTRUST_INSTALL_MODE),Debug)
  MICROTRUST_INSTALL_MODE_LC := debug
else
  MICROTRUST_INSTALL_MODE_LC := release
endif

export MICROTRUST_ADDITIONAL_DEPENDENCIES := $(abspath $(TRUSTZONE_PROJECT_MAKEFILE) $(TRUSTZONE_CUSTOM_BUILD_PATH)/common_config.mk $(TRUSTZONE_CUSTOM_BUILD_PATH)/microtrust_config.mk)
MICROTRUST_ORI_IMAGE_NAME := vendor/mediatek/proprietary/trustzone/microtrust/source/platform/$(ARCH_MTK_PLATFORM)/teei/teei.raw
MICROTRUST_RAW_IMAGE_NAME := $(TRUSTZONE_IMAGE_OUTPUT_PATH)/bin/$(ARCH_MTK_PLATFORM)_microtrust_$(MICROTRUST_INSTALL_MODE_LC)_raw.img
MICROTRUST_TEMP_PADDING_FILE := $(TRUSTZONE_IMAGE_OUTPUT_PATH)/bin/$(ARCH_MTK_PLATFORM)_microtrust_$(MICROTRUST_INSTALL_MODE_LC)_pad.txt
MICROTRUST_TEMP_CFG_FILE := $(TRUSTZONE_IMAGE_OUTPUT_PATH)/bin/img_hdr_microtrust.cfg
MICROTRUST_SIGNED_IMAGE_NAME := $(TRUSTZONE_IMAGE_OUTPUT_PATH)/bin/$(ARCH_MTK_PLATFORM)_microtrust_$(MICROTRUST_INSTALL_MODE_LC)_signed.img
MICROTRUST_PADDING_IMAGE_NAME := $(TRUSTZONE_IMAGE_OUTPUT_PATH)/bin/$(ARCH_MTK_PLATFORM)_microtrust_$(MICROTRUST_INSTALL_MODE_LC)_pad.img
MICROTRUST_COMP_IMAGE_NAME := $(TRUSTZONE_IMAGE_OUTPUT_PATH)/bin/$(ARCH_MTK_PLATFORM)_microtrust.img

$(MICROTRUST_RAW_IMAGE_NAME): $(MICROTRUST_ORI_IMAGE_NAME) $(MICROTRUST_ADDITIONAL_DEPENDENCIES)
	@echo Microtrust build: $@
	$(hide) mkdir -p $(dir $@)
	$(hide) cp -f $(MICROTRUST_ORI_IMAGE_NAME) $@

$(MICROTRUST_TEMP_PADDING_FILE): ALIGNMENT=512
$(MICROTRUST_TEMP_PADDING_FILE): MKIMAGE_HDR_SIZE=512
$(MICROTRUST_TEMP_PADDING_FILE): RSA_SIGN_HDR_SIZE=576
$(MICROTRUST_TEMP_PADDING_FILE): $(MICROTRUST_RAW_IMAGE_NAME) $(MICROTRUST_ADDITIONAL_DEPENDENCIES)
	@echo Microtrust build: $@
	$(hide) mkdir -p $(dir $@)
	$(hide) rm -f $@
	$(hide) FILE_SIZE=$$(($$(wc -c < "$(MICROTRUST_RAW_IMAGE_NAME)")+$(MKIMAGE_HDR_SIZE)+$(RSA_SIGN_HDR_SIZE)));\
	REMAINDER=$$(($${FILE_SIZE} % $(ALIGNMENT)));\
	if [ $${REMAINDER} -ne 0 ]; then dd if=/dev/zero of=$@ bs=$$(($(ALIGNMENT)-$${REMAINDER})) count=1; else touch $@; fi

$(MICROTRUST_TEMP_CFG_FILE): $(TEE_DRAM_SIZE_CFG) $(MICROTRUST_ADDITIONAL_DEPENDENCIES)
	@echo Microtrust build: $@
	$(hide) mkdir -p $(dir $@)
	$(hide) rm -f $@
	@echo "LOAD_MODE = 0" > $@
	@echo "NAME = tee" >> $@
	@echo "LOAD_ADDR =" $(TEE_TOTAL_DRAM_SIZE) >> $@

$(MICROTRUST_PADDING_IMAGE_NAME): $(MICROTRUST_RAW_IMAGE_NAME) $(MICROTRUST_TEMP_PADDING_FILE) $(MICROTRUST_ADDITIONAL_DEPENDENCIES)
	@echo Microtrust build: $@
	$(hide) mkdir -p $(dir $@)
	$(hide) cat $(MICROTRUST_RAW_IMAGE_NAME) $(MICROTRUST_TEMP_PADDING_FILE) > $@

$(MICROTRUST_SIGNED_IMAGE_NAME): ALIGNMENT=512
$(MICROTRUST_SIGNED_IMAGE_NAME): $(MICROTRUST_PADDING_IMAGE_NAME) $(TRUSTZONE_SIGN_TOOL) $(TRUSTZONE_IMG_PROTECT_CFG) $(TEE_DRAM_SIZE_CFG) $(MICROTRUST_ADDITIONAL_DEPENDENCIES)
	@echo Microtrust build: $@
	$(hide) mkdir -p $(dir $@)
	$(hide) $(TRUSTZONE_SIGN_TOOL) $(TRUSTZONE_IMG_PROTECT_CFG) $(MICROTRUST_PADDING_IMAGE_NAME) $@ $(TEE_DRAM_SIZE)
	$(hide) FILE_SIZE=$$(wc -c < "$(MICROTRUST_SIGNED_IMAGE_NAME)");REMAINDER=$$(($${FILE_SIZE} % $(ALIGNMENT)));\
	if [ $${REMAINDER} -ne 0 ]; then echo "[ERROR] File $@ size $${FILE_SIZE} is not $(ALIGNMENT) bytes aligned";exit 1; fi

$(MICROTRUST_COMP_IMAGE_NAME): ALIGNMENT=512
$(MICROTRUST_COMP_IMAGE_NAME): $(MICROTRUST_SIGNED_IMAGE_NAME) $(MTK_MKIMAGE_TOOL) $(MICROTRUST_TEMP_CFG_FILE)  $(MICROTRUST_ADDITIONAL_DEPENDENCIES)
	@echo Microtrust build: $@
	$(hide) mkdir -p $(dir $@)
	$(hide) $(MTK_MKIMAGE_TOOL) $(MICROTRUST_SIGNED_IMAGE_NAME) $(MICROTRUST_TEMP_CFG_FILE) > $@
	$(hide) FILE_SIZE=$$(wc -c < "$(MICROTRUST_COMP_IMAGE_NAME)");REMAINDER=$$(($${FILE_SIZE} % $(ALIGNMENT)));\
	if [ $${REMAINDER} -ne 0 ]; then echo "[ERROR] File $@ size $${FILE_SIZE} is not $(ALIGNMENT) bytes aligned";exit 1; fi

